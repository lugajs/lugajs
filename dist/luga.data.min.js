/*! 
Luga Data 0.4.0 2016-06-30T05:50:11.662Z
Copyright 2013-2016 Massimo Foti (massimo@massimocorner.com)
Licensed under the Apache License, Version 2.0 | http://www.apache.org/licenses/LICENSE-2.0
 */
if("undefined"==typeof luga)throw"Unable to find Luga JS Core";!function(){"use strict";luga.namespace("luga.data"),luga.data.version="0.4.0",luga.data.dataSourceRegistry={},luga.data.CONST={COL_TYPES:["date","number","string"],EVENTS:{CURRENT_ROW_CHANGED:"currentRowChanged",DATA_CHANGED:"dataChanged",DATA_SORTED:"dataSorted",DATA_LOADING:"dataLoading",PRE_DATA_SORTED:"preDataSorted",STATE_CHANGED:"stateChanged",XHR_ERROR:"xhrError"},ERROR_MESSAGES:{DUPLICATED_UUID:"Unable to register dataSource. The uuuid was already used: {0}",INVALID_FILTER_PARAMETER:"Invalid filter. You must use a function as filter",INVALID_FILTER_ACTION:"Invalid action from a filter function. A filter must return either a plain object or null (undefined, primitives etc are not valid return values)",INVALID_UPDATER_PARAMETER:"Invalid updater. You must use a function as updater",INVALID_UPDATER_ACTION:"Invalid action from an updater function. An updater must return a plain object (null, undefined, primitives etc are not valid return values)",INVALID_STATE:"luga.data.utils.assembleStateDescription: Unsupported state: {0}"},PK_KEY:"lugaRowId",PK_KEY_PREFIX:"lugaPk_",XHR_TIMEOUT:1e4},luga.data.getDataSource=function(uuid){return void 0!==luga.data.dataSourceRegistry[uuid]?luga.data.dataSourceRegistry[uuid]:null},luga.data.setDataSource=function(uuid,dataSource){if(null!==luga.data.getDataSource(uuid))throw luga.string.format(luga.data.CONST.ERROR_MESSAGES.DUPLICATED_UUID,[uuid]);luga.data.dataSourceRegistry[uuid]=dataSource},luga.data.STATE={ERROR:"error",LOADING:"loading",READY:"ready"},luga.namespace("luga.data.utils"),luga.data.utils.assembleStateDescription=function(state){if(null!==state&&luga.data.utils.isValidState(state)===!1)throw luga.string.format(luga.data.CONST.ERROR_MESSAGES.INVALID_STATE,[state]);return{state:state,isStateError:state===luga.data.STATE.ERROR,isStateLoading:state===luga.data.STATE.LOADING,isStateReady:state===luga.data.STATE.READY}},luga.data.utils.filter=function(rows,filter,dataset){if(jQuery.isFunction(filter)===!1)throw luga.data.CONST.ERROR_MESSAGES.INVALID_FILTER_PARAMETER;for(var retRows=[],i=0;i<rows.length;i++){var filteredRow=filter(rows[i],i,dataset);if(null!==filteredRow){if(jQuery.isPlainObject(filteredRow)===!1)throw luga.data.CONST.ERROR_MESSAGES.INVALID_FORMATTER_ACTION;retRows.push(filteredRow)}}return retRows},luga.data.utils.update=function(rows,formatter,dataset){if(jQuery.isFunction(formatter)===!1)throw luga.data.CONST.ERROR_MESSAGES.INVALID_UPDATER_ACTION;for(var i=0;i<rows.length;i++){var formattedRow=formatter(rows[i],i,dataset);if(jQuery.isPlainObject(formattedRow)===!1)throw luga.data.CONST.ERROR_MESSAGES.INVALID_UPDATER_ACTION}},luga.data.utils.isValidState=function(state){for(var key in luga.data.STATE)if(luga.data.STATE[key]===state)return!0;return!1}}(),function(){"use strict";luga.data.DataSet=function(options){var CONST={ERROR_MESSAGES:{INVALID_COL_TYPE:"Luga.DataSet.setColumnType(): Invalid type passed {0}",INVALID_UUID_PARAMETER:"Luga.DataSet: uuid parameter is required",INVALID_FORMATTER_PARAMETER:"Luga.DataSet: invalid formatter. You must use a function as formatter",INVALID_FILTER_PARAMETER:"Luga.DataSet: invalid filter. You must use a function as filter",INVALID_PRIMITIVE:"Luga.DataSet: records can be either an array of objects or a single object. Primitives are not accepted",INVALID_PRIMITIVE_ARRAY:"Luga.DataSet: records can be either an array of name/value pairs or a single object. Array of primitives are not accepted",INVALID_ROW_PARAMETER:"Luga.DataSet: invalid row parameter. No available record matches the given row",INVALID_ROW_ID_PARAMETER:"Luga.DataSet: invalid rowId parameter",INVALID_ROW_INDEX_PARAMETER:"Luga.DataSet: invalid parameter. Row index is out of range",INVALID_SORT_COLUMNS:"Luga.DataSet.sort(): Unable to sort dataSet. You must supply one or more column name",INVALID_SORT_ORDER:"Luga.DataSet.sort(): Unable to sort dataSet. Invalid sort order passed {0}",INVALID_STATE:"Luga.DataSet: Unsupported state: {0}"}};if(void 0===options.uuid)throw CONST.ERROR_MESSAGES.INVALID_UUID_PARAMETER;if(void 0!==options.formatter&&jQuery.isFunction(options.formatter)===!1)throw CONST.ERROR_MESSAGES.INVALID_FORMATTER_PARAMETER;if(void 0!==options.filter&&jQuery.isFunction(options.filter)===!1)throw CONST.ERROR_MESSAGES.INVALID_FILTER_PARAMETER;luga.extend(luga.Notifier,this);var self=this;this.uuid=options.uuid,this.records=[],this.recordsHash={},this.formatter=null,void 0!==options.formatter&&(this.formatter=options.formatter),this.filteredRecords=null,this.filter=null,this.state=null,this.currentRowId=null,this.columnTypes={},this.lastSortColumns=[],this.lastSortOrder="",luga.data.setDataSource(this.uuid,this);var deleteAll=function(){self.filteredRecords=null,self.records=[],self.recordsHash={}},applyFilter=function(){hasFilter()===!0&&(self.filteredRecords=luga.data.utils.filter(self.records,self.filter,self),self.resetCurrentRow())},applyFormatter=function(){hasFormatter()===!0&&luga.data.utils.update(self.records,self.formatter,self)},hasFilter=function(){return null!==self.filter},hasFormatter=function(){return null!==self.formatter},selectAll=function(){return hasFilter()===!0?self.filteredRecords:self.records};this.clearFilter=function(){this.filter=null,this.filteredRecords=null,this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},this["delete"]=function(filter){if(void 0===filter)deleteAll();else{if(jQuery.isFunction(filter)===!1)throw CONST.ERROR_MESSAGES.INVALID_FILTER_PARAMETER;for(var orig=this.records,i=0;i<orig.length;i++)if(null===filter(orig[i],i,this)){var rowToDelete=orig[i];this.records.splice(i,1),delete this.recordsHash[rowToDelete[luga.data.CONST.PK_KEY]]}applyFilter()}this.resetCurrentRow(),this.setState(luga.data.STATE.READY),this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},this.getColumnType=function(columnName){return void 0!==this.columnTypes[columnName]?this.columnTypes[columnName]:"string"},this.getContext=function(){var context={entities:self.select(),recordCount:self.getRecordsCount()},stateDesc=luga.data.utils.assembleStateDescription(self.getState());return luga.merge(context,stateDesc),context},this.getCurrentRow=function(){return this.getRowById(this.getCurrentRowId())},this.getCurrentRowId=function(){return this.currentRowId},this.getCurrentRowIndex=function(){var row=this.getCurrentRow();return this.getRowIndex(row)},this.getRecordsCount=function(){return selectAll().length},this.getRowById=function(rowId){var targetRow=this.recordsHash[rowId];return void 0===targetRow?null:hasFilter()===!0?-1!==this.filteredRecords.indexOf(targetRow)?targetRow:null:targetRow},this.getRowByIndex=function(index){var fetchedRow;if(fetchedRow=hasFilter()===!0?this.filteredRecords[index]:this.records[index],void 0===fetchedRow)throw CONST.ERROR_MESSAGES.INVALID_ROW_INDEX_PARAMETER;return fetchedRow},this.getRowIndex=function(row){return hasFilter()===!0?this.filteredRecords.indexOf(row):this.records.indexOf(row)},this.getSortColumn=function(){return this.lastSortColumns&&this.lastSortColumns.length>0?this.lastSortColumns[0]:""},this.getSortOrder=function(){return this.lastSortOrder?this.lastSortOrder:""},this.getState=function(){return this.state},this.insert=function(records){var recordsHolder=[];if(jQuery.isArray(records)===!0)recordsHolder=records;else{if(jQuery.isPlainObject(records)===!1)throw CONST.ERROR_MESSAGES.INVALID_PRIMITIVE;recordsHolder.push(records)}for(var i=0;i<recordsHolder.length;i++){if(jQuery.isPlainObject(recordsHolder[i])===!1)throw CONST.ERROR_MESSAGES.INVALID_PRIMITIVE_ARRAY;var recordID=luga.data.CONST.PK_KEY_PREFIX+this.records.length;recordsHolder[i][luga.data.CONST.PK_KEY]=recordID,this.recordsHash[recordID]=recordsHolder[i],this.records.push(recordsHolder[i])}applyFormatter(),applyFilter(),this.resetCurrentRow(),this.setState(luga.data.STATE.READY),this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},this.resetCurrentRow=function(){if(null!==this.currentRowId){var targetRow=this.getRowById(this.currentRowId);if(null!==targetRow)return void this.setCurrentRowId(this.currentRowId)}this.resetCurrentRowToFirst()},this.resetCurrentRowToFirst=function(){return hasFilter()===!0?null===this.filteredRecords||0===this.filteredRecords.length?void this.setCurrentRowId(null):void this.setCurrentRowId(this.filteredRecords[0][luga.data.CONST.PK_KEY]):void(this.records.length>0?this.setCurrentRowId(this.records[0][luga.data.CONST.PK_KEY]):this.setCurrentRowId(null))},this.select=function(filter){if(void 0===filter)return selectAll();if(jQuery.isFunction(filter)===!1)throw CONST.ERROR_MESSAGES.INVALID_FILTER_PARAMETER;return luga.data.utils.filter(selectAll(),filter,self)},this.setColumnType=function(columnNames,columnType){jQuery.isArray(columnNames)===!1&&(columnNames=[columnNames]);for(var i=0;i<columnNames.length;i++){var colName=columnNames[i];if(-1===luga.data.CONST.COL_TYPES.indexOf(columnType))throw luga.string.format(CONST.ERROR_MESSAGES.INVALID_COL_TYPE,[colName]);this.columnTypes[colName]=columnType}},this.setCurrentRowId=function(rowId){if(this.currentRowId!==rowId){var notificationData={oldRowId:this.getCurrentRowId(),oldRow:this.getRowById(this.currentRowId),currentRowId:rowId,currentRow:this.getRowById(rowId),dataSet:this};if(null===rowId&&null!==this.currentRowId)return this.currentRowId=null,void this.notifyObservers(luga.data.CONST.EVENTS.CURRENT_ROW_CHANGED,notificationData);if(null===this.getRowById(rowId))throw CONST.ERROR_MESSAGES.INVALID_ROW_ID_PARAMETER;this.currentRowId=rowId,this.notifyObservers(luga.data.CONST.EVENTS.CURRENT_ROW_CHANGED,notificationData)}},this.setCurrentRow=function(row){var fetchedRowId=this.getRowIndex(row);if(-1===fetchedRowId)throw CONST.ERROR_MESSAGES.INVALID_ROW_PARAMETER;this.setCurrentRowId(luga.data.CONST.PK_KEY_PREFIX+fetchedRowId)},this.setCurrentRowIndex=function(index){this.setCurrentRow(this.getRowByIndex(index))},this.setFilter=function(filter){if(jQuery.isFunction(filter)===!1)throw CONST.ERROR_MESSAGES.INVALID_FILTER_PARAMETER;this.filter=filter,applyFilter(),this.setState(luga.data.STATE.READY),this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},this.setState=function(newState){if(luga.data.utils.isValidState(newState)===!1)throw luga.string.format(CONST.ERROR_MESSAGES.INVALID_STATE,[newState]);var oldState=this.state;this.state=newState;var notificationData={oldState:oldState,currentState:this.state,dataSet:this};this.notifyObservers(luga.data.CONST.EVENTS.STATE_CHANGED,notificationData)},this.sort=function(columnNames,sortOrder){if(void 0===columnNames||null===columnNames)throw CONST.ERROR_MESSAGES.INVALID_SORT_COLUMNS;if(void 0===sortOrder&&(sortOrder=luga.data.sort.ORDER.TOG),luga.data.sort.isValidSortOrder(sortOrder)===!1)throw luga.string.format(CONST.ERROR_MESSAGES.INVALID_SORT_ORDER,[sortOrder]);var sortColumns=assembleSortColumns(columnNames);sortOrder===luga.data.sort.ORDER.TOG&&(sortOrder=defineToggleSortOrder(sortColumns));var notificationData={dataSet:this,oldSortColumns:this.lastSortColumns,oldSortOrder:this.lastSortOrder,newSortColumns:sortColumns,newSortOrder:sortOrder};this.notifyObservers(luga.data.CONST.EVENTS.PRE_DATA_SORTED,notificationData);for(var sortColumnName=sortColumns[sortColumns.length-1],sortColumnType=this.getColumnType(sortColumnName),sortFunction=luga.data.sort.getSortStrategy(sortColumnType,sortOrder),i=sortColumns.length-2;i>=0;i--){var columnToSortName=sortColumns[i],columnToSortType=this.getColumnType(columnToSortName),sortStrategy=luga.data.sort.getSortStrategy(columnToSortType,sortOrder);sortFunction=buildSecondarySortFunction(sortStrategy(columnToSortName),sortFunction)}this.records.sort(sortFunction),applyFilter(),this.resetCurrentRowToFirst(),this.setState(luga.data.STATE.READY),this.notifyObservers(luga.data.CONST.EVENTS.DATA_SORTED,notificationData),this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this}),this.lastSortColumns=sortColumns.slice(0),this.lastSortOrder=sortOrder};var buildSecondarySortFunction=function(funcA,funcB){return function(a,b){var ret=funcA(a,b);return 0===ret&&(ret=funcB(a,b)),ret}},assembleSortColumns=function(columnNames){return jQuery.isArray(columnNames)===!1?[columnNames,luga.data.CONST.PK_KEY]:columnNames.length<2&&columnNames[0]!==luga.data.CONST.PK_KEY?(columnNames.push(luga.data.CONST.PK_KEY),columnNames):columnNames},defineToggleSortOrder=function(sortColumns){return self.lastSortColumns.length>0&&self.lastSortColumns[0]===sortColumns[0]&&self.lastSortOrder===luga.data.sort.ORDER.ASC?luga.data.sort.ORDER.DESC:luga.data.sort.ORDER.ASC};this.update=function(filter,updater){var filteredRecords=luga.data.utils.filter(this.records,filter,this);luga.data.utils.update(filteredRecords,updater,this),this.resetCurrentRow(),this.setState(luga.data.STATE.READY),this.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},void 0!==options.filter&&this.setFilter(options.filter),void 0!==options.records&&this.insert(options.records)}}(),function(){"use strict";luga.data.DetailSet=function(options){var CONST={ERROR_MESSAGES:{INVALID_UUID_PARAMETER:"Luga.DetailSet: id parameter is required",INVALID_DS_PARAMETER:"Luga.DetailSet: dataSet parameter is required"}};if(void 0===options.uuid)throw CONST.ERROR_MESSAGES.INVALID_UUID_PARAMETER;if(void 0===options.dataSet)throw CONST.ERROR_MESSAGES.INVALID_DS_PARAMETER;luga.extend(luga.Notifier,this);var self=this;this.uuid=options.uuid,this.dataSet=options.dataSet,this.dataSet.addObserver(this),this.row=null,luga.data.setDataSource(this.uuid,this),this.getContext=function(){var context={entity:self.row},stateDesc=luga.data.utils.assembleStateDescription(self.getState());return luga.merge(context,stateDesc),context},this.getState=function(){return self.dataSet.getState()},this.fetchRow=function(){self.row=self.dataSet.getCurrentRow(),self.notifyObservers(luga.data.CONST.EVENTS.DATA_CHANGED,{dataSource:this})},this.onDataChangedHandler=function(data){self.fetchRow()},this.onCurrentRowChangedHandler=function(data){self.fetchRow()},this.onStateChangedHandler=function(data){self.fetchRow()},self.row=self.dataSet.getCurrentRow()}}(),function(){"use strict";luga.data.HttpDataSet=function(options){luga.extend(luga.data.DataSet,this,[options]);var self=this,CONST={ERROR_MESSAGES:{HTTP_DATA_SET_ABSTRACT:"luga.data.HttpDataSet is an abstract class",XHR_FAILURE:"Failed to retrieve: {0}. HTTP status: {1}. Error: {2}",NEED_URL_TO_LOAD:"Unable to call loadData(). DataSet is missing a URL"}};if(this.constructor===luga.data.HttpDataSet)throw CONST.ERROR_MESSAGES.HTTP_DATA_SET_ABSTRACT;this.url=null,void 0!==options.url&&(this.url=options.url),this.timeout=luga.data.CONST.XHR_TIMEOUT,void 0!==options.timeout&&(this.timeout=options.timeout),this.cache=!0,void 0!==options.cache&&(this.cache=options.cache),this.headers={},void 0!==options.headers&&(this.headers=options.headers),this.incrementalLoad=!1,void 0!==options.incrementalLoad&&(this.incrementalLoad=options.incrementalLoad),this.dataType=null,this.xhrRequest=null;var loadUrl=function(){var xhrOptions={url:self.url,success:function(response,textStatus,jqXHR){self.incrementalLoad===!1&&self["delete"](),self.loadRecords(response,textStatus,jqXHR)},timeout:self.timeout,cache:self.cache,headers:self.headers,error:self.xhrError,converters:{"text xml":luga.xml.parseFromString}};null!==self.dataType&&(xhrOptions.dataType=self.dataType),self.xhrRequest=jQuery.ajax(xhrOptions)};this.cancelRequest=function(){null!==this.xhrRequest&&(this.xhrRequest.abort(),this.xhrRequest=null)},this.getUrl=function(){return this.url},this.loadData=function(){if(null===this.url)throw CONST.ERROR_MESSAGES.NEED_URL_TO_LOAD;this.setState(luga.data.STATE.LOADING),this.notifyObservers(luga.data.CONST.EVENTS.DATA_LOADING,{dataSet:this}),this.cancelRequest(),loadUrl()},this.loadRecords=function(response,textStatus,jqXHR){},this.setUrl=function(newUrl){this.url=newUrl},this.xhrError=function(jqXHR,textStatus,errorThrown){self.setState(luga.data.STATE.ERROR),self.notifyObservers(luga.data.CONST.EVENTS.XHR_ERROR,{dataSet:self,message:luga.string.format(CONST.ERROR_MESSAGES.XHR_FAILURE,[self.url,jqXHR.status,errorThrown]),jqXHR:jqXHR,textStatus:textStatus,errorThrown:errorThrown})}}}(),function(){"use strict";luga.data.JsonDataSet=function(options){luga.extend(luga.data.HttpDataSet,this,[options]);var self=this;this.dataType="json",this.path=null,void 0!==options.path&&(this.path=options.path),this.rawJson=null,this.getRawJson=function(){return this.rawJson},this.getPath=function(){return this.path},this.loadRawJson=function(json){self["delete"](),self.loadRecords(json)},this.loadRecords=function(json,textStatus,jqXHR){if(self.rawJson=json,null===self.path)self.insert(json);else{var records=luga.lookupProperty(json,self.path);void 0!==records&&self.insert(records)}},this.setPath=function(path){this.path=path}}}(),function(){"use strict";luga.data.XmlDataSet=function(options){luga.extend(luga.data.HttpDataSet,this,[options]);var self=this;this.dataType="xml",this.path="/",void 0!==options.path&&(this.path=options.path),this.rawXml=null,this.getRawXml=function(){return this.rawXml},this.getPath=function(){return this.path},this.loadRawXml=function(node){self["delete"](),self.loadRecords(node)},this.loadRecords=function(xmlDoc,textStatus,jqXHR){self.rawXml=xmlDoc;for(var nodes=luga.xml.evaluateXPath(xmlDoc,self.path),records=[],i=0;i<nodes.length;i++)records.push(luga.xml.nodeToObject(nodes[i]));self.insert(records)},this.setPath=function(path){this.path=path}}}(),function(){"use strict";luga.data.ChildJsonDataSet=function(options){var CONST={ERROR_MESSAGES:{MISSING_PARENT_DS:"luga.data.ChildJsonDataSet: parentDataSet parameter is required",MISSING_URL:"luga.data.ChildJsonDataSet: url parameter is required",FAILED_URL_BINDING:"luga.data.ChildJsonDataSet: unable to generate valid URL: {0}"}};if(void 0===options.parentDataSet)throw CONST.ERROR_MESSAGES.MISSING_PARENT_DS;if(void 0===options.url)throw CONST.ERROR_MESSAGES.MISSING_URL;luga.extend(luga.data.JsonDataSet,this,[options]);var self=this;this.parentDataSet=options.parentDataSet,this.parentDataSet.addObserver(this),this.url=null,this.urlPattern=options.url,this.fetchData=function(row){var bindUrl=luga.string.replaceProperty(self.urlPattern,row);if(bindUrl===self.urlPattern)throw luga.string.format(CONST.ERROR_MESSAGES.FAILED_URL_BINDING,[bindUrl]);self.setUrl(bindUrl),self.loadData()},this.onCurrentRowChangedHandler=function(data){null!==data.currentRow?self.fetchData(data.currentRow):self["delete"]()}}}(),function(){"use strict";luga.namespace("luga.data.region"),luga.data.region.CONST={CUSTOM_ATTRIBUTES:{DATA_SOURCE_UUID:"data-lugaregion-datasource-uuid",REGION:"data-lugaregion",REGION_TYPE:"data-lugaregion-type",TEMPLATE_ID:"data-lugaregion-template-id",TRAITS:"data-lugaregion-traits",REGION_REFERENCE:"luga-region-reference"},DEFAULT_REGION_TYPE:"luga.data.region.Handlebars",DEFAULT_TRAITS:["luga.data.region.traits.select","luga.data.region.traits.setRowId","luga.data.region.traits.setRowIndex","luga.data.region.traits.sort"],ERROR_MESSAGES:{MISSING_DATA_SOURCE_ATTRIBUTE:"Missing required data-lugaregion-datasource-uuid attribute inside region",MISSING_DATA_SOURCE:"Unable to find datasource {0}",MISSING_REGION_TYPE_FUNCTION:"Failed to create region. Unable to find a constructor function named: {0}"},EVENTS:{REGION_RENDERED:"regionRendered"},SELECTORS:{REGION:"*[data-lugaregion='true']"}},luga.data.region.getReferenceFromNode=function(node){return node.data(luga.data.region.CONST.CUSTOM_ATTRIBUTES.REGION_REFERENCE)},luga.data.region.init=function(node){var dataSourceId=node.attr(luga.data.region.CONST.CUSTOM_ATTRIBUTES.DATA_SOURCE_UUID);if(void 0===dataSourceId)throw luga.data.region.CONST.ERROR_MESSAGES.MISSING_DATA_SOURCE_ATTRIBUTE;var dataSource=luga.data.getDataSource(dataSourceId);if(null===dataSource)throw luga.string.format(luga.data.region.CONST.ERROR_MESSAGES.MISSING_DATA_SOURCE,[dataSourceId]);var regionType=node.attr(luga.data.region.CONST.CUSTOM_ATTRIBUTES.REGION_TYPE);void 0===regionType&&(regionType=luga.data.region.CONST.DEFAULT_REGION_TYPE);var RegionClass=luga.lookupFunction(regionType);if(void 0===RegionClass)throw luga.string.format(luga.data.region.CONST.ERROR_MESSAGES.MISSING_REGION_TYPE_FUNCTION,[regionType]);new RegionClass({node:node})},luga.namespace("luga.data.region.utils"),luga.data.region.utils.assembleRegionDescription=function(region){return{node:region.config.node,ds:region.dataSource}},jQuery(document).ready(function(){jQuery(luga.data.region.CONST.SELECTORS.REGION).each(function(index,item){luga.data.region.init(jQuery(item))})})}(),function(){"use strict";luga.data.region.Base=function(options){if(luga.extend(luga.Notifier,this),this.CONST={ERROR_MESSAGES:{INVALID_TRAIT:"luga.data.region invalid trait: {0} is not a function",MISSING_NODE:"luga.data.region was unable find the region node"}},options.node=jQuery(options.node),0===options.node.length)throw this.CONST.ERROR_MESSAGES.MISSING_NODE;this.config={node:null,dsUuid:options.node.attr(luga.data.region.CONST.CUSTOM_ATTRIBUTES.DATA_SOURCE_UUID)||null,templateId:options.node.attr(luga.data.region.CONST.CUSTOM_ATTRIBUTES.TEMPLATE_ID)||null,traits:options.traits||null,ds:null},luga.merge(this.config,options);var self=this;if(this.dataSource=null,null!==this.config.ds?this.dataSource=this.config.ds:this.dataSource=luga.data.getDataSource(this.config.dsUuid),null===this.dataSource)throw luga.string.format(luga.data.region.CONST.ERROR_MESSAGES.MISSING_DATA_SOURCE,[this.config.dsId]);this.dataSource.addObserver(this),this.traits=luga.data.region.CONST.DEFAULT_TRAITS;var attrTraits=this.config.node.attr(luga.data.region.CONST.CUSTOM_ATTRIBUTES.TRAITS);void 0!==attrTraits&&(this.traits=this.traits.concat(attrTraits.split(","))),null!==this.config.traits&&(this.traits=this.traits.concat(this.config.traits)),this.config.node.data(luga.data.region.CONST.CUSTOM_ATTRIBUTES.REGION_REFERENCE,this),this.applyTraits=function(){for(var traitData={node:this.config.node,dataSource:this.dataSource},i=0;i<this.traits.length;i++){var func=luga.lookupFunction(this.traits[i]);if(void 0===func)throw luga.string.format(this.CONST.ERROR_MESSAGES.INVALID_TRAIT,[this.traits[i]]);func(traitData)}},this.render=function(){var desc=luga.data.region.utils.assembleRegionDescription(this);this.notifyObservers(luga.data.region.CONST.EVENTS.REGION_RENDERED,desc)},this.onCurrentRowChangedHandler=function(data){self.applyTraits()},this.onDataChangedHandler=function(data){self.render()},this.onStateChangedHandler=function(data){self.render()}}}(),function(){"use strict";luga.data.region.Handlebars=function(options){luga.extend(luga.data.region.Base,this,[options]);var self=this;self.CONST.HANDLEBARS_ERROR_MESSAGES={MISSING_HANDLEBARS:"Unable to find Handlebars",MISSING_TEMPLATE_FILE:"luga.data.region.Handlebars was unable to retrieve file: {0} containing an Handlebars template",MISSING_TEMPLATE_NODE:"luga.data.region.Handlebars was unable find an HTML element with id: {0} containing an Handlebars template"},this.template="";var fetchTemplate=function(node){if(null===self.config.templateId)self.template=Handlebars.compile(node.html());else{var templateNode=jQuery("#"+self.config.templateId);if(1!==templateNode.length)throw luga.string.format(self.CONST.HANDLEBARS_ERROR_MESSAGES.MISSING_TEMPLATE_NODE,[self.config.templateId]);var templateSrc=templateNode.attr("src");if(void 0===templateSrc)self.template=Handlebars.compile(templateNode.html());else{var xhrOptions={url:templateSrc,dataType:"text",success:function(response,textStatus,jqXHR){self.template=Handlebars.compile(response),self.render()},error:function(jqXHR,textStatus,errorThrown){throw luga.string.format(self.CONST.HANDLEBARS_ERROR_MESSAGES.MISSING_TEMPLATE_FILE,[templateSrc])}};jQuery.ajax(xhrOptions)}}};this.generateHtml=function(){return this.template(this.dataSource.getContext())},this.render=function(){if(""!==this.template){this.config.node.html(this.generateHtml()),this.applyTraits();var desc=luga.data.region.utils.assembleRegionDescription(this);this.notifyObservers(luga.data.region.CONST.EVENTS.REGION_RENDERED,desc)}},fetchTemplate(this.config.node)}}(),function(){"use strict";luga.namespace("luga.data.region.traits");var CONST={CUSTOM_ATTRIBUTES:{SELECT:"data-lugaregion-select",SET_ROW_ID:"data-lugaregion-setrowid",SET_ROW_INDEX:"data-lugaregion-setrowindex",SORT:"data-lugaregion-sort"},SELECTORS:{SELECT:"*[data-lugaregion-select]",SET_ROW_ID:"*[data-lugaregion-setrowid]",SET_ROW_INDEX:"*[data-lugaregion-setrowindex]",SORT:"*[data-lugaregion-sort]"}};luga.data.region.traits.select=function(options){var nodes=options.node.find(CONST.SELECTORS.SELECT);if(nodes.length>0){if(void 0===options.dataSource.getCurrentRowIndex)return;var cssClass=nodes.attr(CONST.CUSTOM_ATTRIBUTES.SELECT);nodes.removeClass(cssClass);var index=0;-1===options.dataSource.getCurrentRowIndex()?nodes.removeClass(cssClass):(index=options.dataSource.getCurrentRowIndex(),jQuery(nodes.get(index)).addClass(cssClass)),nodes.each(function(index,item){var jItem=jQuery(item);jItem.click(function(event){event.preventDefault(),nodes.removeClass(cssClass),jItem.addClass(cssClass)})})}},luga.data.region.traits.setRowId=function(options){options.node.find(CONST.SELECTORS.SET_ROW_ID).each(function(index,item){var jItem=jQuery(item);jItem.click(function(event){event.preventDefault();var rowId=jItem.attr(CONST.CUSTOM_ATTRIBUTES.SET_ROW_ID);options.dataSource.setCurrentRowId(rowId)})})},luga.data.region.traits.setRowIndex=function(options){options.node.find(CONST.SELECTORS.SET_ROW_INDEX).each(function(index,item){var jItem=jQuery(item);jItem.click(function(event){event.preventDefault();var rowIndex=parseInt(jItem.attr(CONST.CUSTOM_ATTRIBUTES.SET_ROW_INDEX),10);options.dataSource.setCurrentRowIndex(rowIndex)})})},luga.data.region.traits.sort=function(options){options.node.find(CONST.SELECTORS.SORT).each(function(index,item){var jItem=jQuery(item);jItem.click(function(event){event.preventDefault();var sortCol=jItem.attr(CONST.CUSTOM_ATTRIBUTES.SORT);options.dataSource.sort(sortCol)})})}}(),function(){"use strict";luga.namespace("luga.data.sort"),luga.data.sort.ORDER={ASC:"ascending",DESC:"descending",TOG:"toggle"};var CONST={ERROR_MESSAGES:{UNSUPPORTED_DATA_TYPE:"luga.data.sort. Unsupported dataType: {0",UNSUPPORTED_SORT_ORDER:"luga.data.sort. Unsupported sortOrder: {0}"}};luga.data.sort.isValidSortOrder=function(sortOrder){for(var key in luga.data.sort.ORDER)if(luga.data.sort.ORDER[key]===sortOrder)return!0;return!1},luga.data.sort.getSortStrategy=function(dataType,sortOrder){if(void 0===luga.data.sort[dataType])throw luga.string.format(CONST.ERROR_MESSAGES.UNSUPPORTED_DATA_TYPE,[dataType]);if(void 0===luga.data.sort[dataType][sortOrder])throw luga.string.format(CONST.ERROR_MESSAGES.UNSUPPORTED_SORT_ORDER,[sortOrder]);return luga.data.sort[dataType][sortOrder]},luga.namespace("luga.data.sort.date"),luga.data.sort.date.ascending=function(prop){return function(a,b){var dA=luga.lookupProperty(a,prop),dB=luga.lookupProperty(b,prop);return dA=dA?new Date(dA):0,dB=dB?new Date(dB):0,dA-dB}},luga.data.sort.date.descending=function(prop){return function(a,b){var dA=luga.lookupProperty(a,prop),dB=luga.lookupProperty(b,prop);return dA=dA?new Date(dA):0,dB=dB?new Date(dB):0,dB-dA}},luga.namespace("luga.data.sort.number"),luga.data.sort.number.ascending=function(prop){return function(a,b){return a=luga.lookupProperty(a,prop),b=luga.lookupProperty(b,prop),void 0===a||void 0===b?a===b?0:a?1:-1:a-b}},luga.data.sort.number.descending=function(prop){return function(a,b){return a=luga.lookupProperty(a,prop),b=luga.lookupProperty(b,prop),void 0===a||void 0===b?a===b?0:a?-1:1:b-a}},luga.namespace("luga.data.sort.string"),luga.data.sort.string.ascending=function(prop){return function(a,b){if(a=luga.lookupProperty(a,prop),b=luga.lookupProperty(b,prop),void 0===a||void 0===b)return a===b?0:a?1:-1;for(var tA=a.toString(),tB=b.toString(),tAlower=tA.toLowerCase(),tBlower=tB.toLowerCase(),minLen=tA.length>tB.length?tB.length:tA.length,i=0;minLen>i;i++){var aLowerChar=tAlower.charAt(i),bLowerChar=tBlower.charAt(i),aChar=tA.charAt(i),bChar=tB.charAt(i);if(aLowerChar>bLowerChar)return 1;if(bLowerChar>aLowerChar)return-1;if(aChar>bChar)return 1;if(bChar>aChar)return-1}return tA.length===tB.length?0:tA.length>tB.length?1:-1}},luga.data.sort.string.descending=function(prop){return function(a,b){if(a=luga.lookupProperty(a,prop),b=luga.lookupProperty(b,prop),void 0===a||void 0===b)return a===b?0:a?-1:1;for(var tA=a.toString(),tB=b.toString(),tAlower=tA.toLowerCase(),tBlower=tB.toLowerCase(),minLen=tA.length>tB.length?tB.length:tA.length,i=0;minLen>i;i++){var aLowerChar=tAlower.charAt(i),bLowerChar=tBlower.charAt(i),aChar=tA.charAt(i),bChar=tB.charAt(i);if(aLowerChar>bLowerChar)return-1;if(bLowerChar>aLowerChar)return 1;if(aChar>bChar)return-1;if(bChar>aChar)return 1}return tA.length===tB.length?0:tA.length>tB.length?-1:1}}}(),function(){"use strict";luga.namespace("luga.data.widgets"),luga.data.widgets.ShowMore=function(options){this.CONST={ERROR_MESSAGES:{INVALID_DATASET_PARAMETER:"luga.data.widgets.ShowMore: dataSet parameter is required",INVALID_URL_PARAMETER:"luga.data.widgets.ShowMore: url parameter is required"}},this.config={dataSet:void 0,paramPath:"",url:void 0},luga.merge(this.config,options);var self=this;if(void 0===this.config.dataSet)throw this.CONST.ERROR_MESSAGES.INVALID_DATASET_PARAMETER;if(void 0===this.config.url)throw this.CONST.ERROR_MESSAGES.INVALID_URL_PARAMETER;var isEnabled=!1;this.config.dataSet.addObserver(this),this.assembleUrl=function(){var bindingObj=this.config.dataSet.getRawJson();return""!==this.config.paramPath&&(bindingObj=luga.lookupProperty(bindingObj,this.config.paramPath)),luga.string.replaceProperty(this.config.url,bindingObj)},this.disable=function(){},this.enable=function(){},this.fetch=function(){var newUrl=this.assembleUrl();newUrl!==this.config.url?(this.config.dataSet.setUrl(newUrl),this.config.dataSet.loadData()):this.disable()},this.isEnabled=function(){return isEnabled},this.updateState=function(){this.config.dataSet.getState()===luga.data.STATE.READY?(isEnabled=!0,this.enable()):(isEnabled=!1,this.disable())},this.onStateChangedHandler=function(data){self.updateState()},this.updateState()},luga.data.widgets.ShowMoreButton=function(options){this.config={dataSet:void 0,paramPath:"",url:void 0,button:void 0,disabledClass:"disabled"},luga.merge(this.config,options),luga.extend(luga.data.widgets.ShowMore,this,[this.config]);var self=this;if(self.CONST.BUTTON_ERROR_MESSAGES={MISSING_BUTTON:"luga.data.widgets.ShowMoreButton was unable find the button node"},this.config.button=jQuery(this.config.button),0===this.config.button.length)throw this.CONST.BUTTON_ERROR_MESSAGES.MISSING_BUTTON;this.attachEvents=function(){jQuery(self.config.button).on("click",function(event){event.preventDefault(),self.isEnabled()===!0&&self.fetch()})},this.disable=function(){this.config.button.addClass(this.config.disabledClass)},this.enable=function(){this.config.button.removeClass(this.config.disabledClass)},this.attachEvents()},luga.data.widgets.ShowMoreScrolling=function(options){this.config={dataSet:void 0,paramPath:"",url:void 0,node:jQuery("body")},luga.merge(this.config,options),luga.extend(luga.data.widgets.ShowMore,this,[this.config]);var self=this,scrollBody=!1;void 0===this.config.node&&(scrollBody=!0,this.config.node=jQuery(document)),this.attachEvents=function(){var targetNode=self.config.node;jQuery(targetNode).scroll(function(){var scrolledToBottom=!1;scrollBody===!0?jQuery(targetNode).scrollTop()===jQuery(targetNode).height()-jQuery(window).height()&&(scrolledToBottom=!0):jQuery(targetNode).scrollTop()>=targetNode[0].scrollHeight-targetNode.height()&&(scrolledToBottom=!0),scrolledToBottom===!0&&self.isEnabled()===!0&&self.fetch();
})},this.attachEvents()}}();
//# sourceMappingURL=luga.data.min.js.map
